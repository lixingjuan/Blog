# 为什么js是单线程？

这个和js的工作有关，js主要工作在浏览器，而浏览器的主要工作是实现用户交互，效果呈现，如果一个线程在一个DOM节点修改内容，另一个线程删除了该DOM节点，此时应该以谁为主？此时就会引起冲突
于是js采用单线程的运行机制；

为了利用多核CPU的计算能力，HTML5提出Web Worker标准，允许JavaScript 创建多个线程，但是子线程完全受主线程控制，且不得操作DOM。
所以该标准并没有改变js单线程的本质；

## 任务队列

单线程就意味着所有任务都需要排队，前一个任务执行完，才会执行下一个任务。如果前一个任务耗时很长，后一个任务就不得不一支等着。
但是这种机制导致很多时候，CPU都是空闲的。因为IO设备很慢（比如网络请求），CPU会一直等待结果出来，再往下执行计算。
这样造成CPU大量时间都是等待过程，由于js的解析机制是从上向下按顺序解析，如果网络卡顿，就会堵塞页面渲染；

于是js语言的设计者意识到，这时主线程完全可以不管IO设备，挂起等待中的任务，先运行排在后面的任务，等IO设备返回了结果，再回过头执行挂起的任务。

于是，所有的任务可以分为两种：同步任务和异步任务；
同步任务指的是，在主线程上排队执行的任务，只有当前一个任务执行完毕，才会执行下一个任务；
异步任务指的是，不进入主线程，而进入任务队列（task queue）的任务, 只有任务队列通知主线程异步任务可以执行了，该异步任务才会进入主线程；

异步执行的运行机制

1. 所有同步任务都在主线程上执行，形成一个执行栈；
2. 主线程之外，还存在一个 “任务队列”， 只要异步任务有了结果，就在任务队列放置一个任务；
3. 一旦执行栈的同步任务执行完毕，主线程就会读取 “任务队列” ，异步任务就结束等待状态，进入执行站，开始执行；
4. 循环以上三个步骤；


## 事件和回调函数

任务队列实际上是一个事件队列，主线程读取任务队列，就是读取里面有哪些事件。

“任务队列” 中的事件，除了IO设备的事件意外，还包括一些用户产生的事件（鼠标点击，页面滚动等等），只要指定过回调函数，这些事件发生时就会进入任务队列，等待主线程读取。

所谓回调函数，就是会被主线程挂起来的代码。异步任务必须指定回调函数，当主线程开始执行异步任务，就是执行对应的回调函数。

“任务队列”是一个先进先出的执行顺序，只要执行栈一空，“任务队列”第一位的事件就自动进入主线程，但是由于存在“定时器”功能，主线程首先会检查下执行时间，某些事件只有到了规定的时间，才能返回主线程；

## 定时器

setTimeout()只是将事件插入到“任务队列”，必须等到当前执行栈代码执行完毕，才会去执行他指定的回调函数，如果当前代码耗时特别久，那setTimeout()的回调函数可能要等很久，所以并不能保证回调函数一定会在其指定的时间执行。

# CPU

- 计算机的核心，负责计算功能；


## 进程
一个具有一定独立功能的程序在一个数据集上的一次动态执行的过程，是操作系统进行资源分配和调度的独立单位，是应用程序运行的载体


## 线程
线程是程序执行中一个单一的顺序控制流程，是程序执行流的最小单元


## 进程和线程的区别和关系
1. 一个进程由一个或多个线程组成，线程是一个进程中代码的不同执行路线；
2. 进程是操作系统分配资源的最小单位，线程是程序执行的最小单位；
3. 进程之间相互独立，但同一进程下的各个线程之间共享程序的内存空间(包括代码段、数据集、堆等)及一些进程级的资源(如打开文件和信号)；
4. 调度和切换：线程上下文切换比进程上下文切换要快得多；

## 浏览器内核
浏览器内核是通过取得页面内容、整理信息（应用CSS）、计算和组合最终输出可视化的图像结果，通常也被称为渲染引擎。从上面我们可以知道，Chrome浏览器为每个tab页面单独启用进程，因此每个tab网页都有由其独立的渲染引擎实例。

## 浏览器内核是多线程

**浏览器常驻线程**

浏览器内核是多线程，在内核控制下各线程相互配合以保持同步
    GUI 渲染线程
    JavaScript引擎线程
    定时触发器线程
    事件触发线程
    异步http请求线程


**GUI 渲染线程**
负责渲染浏览器界面html元素，当界面需要重绘或者由于某种操作引发回流的话，该线程就会执行，再jsvascript引擎运行脚本期间，GUI渲染线程都处于挂起状态，也就是说被'冻结'了



**JavaScript引擎线程**

也称js内核，主要负责javascript脚本程序，例如v8引擎，
用于解析js脚本，运行代码

**定时触发器线程**

浏览器定时计数器并不是由JavaScript引擎计数的, 因为JavaScript引擎是单线程的, 如果处于阻塞线程状态就会影响记计时的准确, 因此通过单独线程来计时并触发定时是更为合理的方案。




**事件触发线程**

当一个事件被触发时该线程会把事件添加到待处理队列的队尾，等待JS引擎的处理。这些事件可以是当前执行的代码块如定时任务、也可来自浏览器内核的其他线程如鼠标点击、AJAX异步请求等，但由于JS的单线程关系所有这些事件都得排队等待JS引擎处理




**异步http请求线程**

在XMLHttpRequest在连接后是通过浏览器新开一个线程请求， 将检测到状态变更时，如果设置有回 调函数，异步线程就产生状态变更事件放到JavaScript引擎的处理队列中等待处理




## GUI 渲染线程 与 JavaScript引擎线程互斥
一个运行另一个就会挂起
若GUI 渲染线程 与 JavaScript引擎线程同时运行，以免渲染引擎前后获得DOM数据不一致